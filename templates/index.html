<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Booking Cancellation Predictor</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <!-- Chart.js for advanced visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <header>
            <h1><i class="fas fa-hotel"></i> Hotel Booking Cancellation Predictor</h1>
            <p class="subtitle">AI-powered prediction system to reduce revenue loss and optimize hotel operations</p>
            
            <div class="business-value">
                <h3><i class="fas fa-chart-line"></i> Business Value Proposition</h3>
                <p>This predictive model helps hotels reduce lost revenue by identifying high-risk bookings and enabling proactive interventions.</p>
                
                <div class="value-points">
                    <div class="value-point"><i class="fas fa-dollar-sign"></i> Reduce lost revenue</div>
                    <div class="value-point"><i class="fas fa-users"></i> Optimize overbooking policies</div>
                    <div class="value-point"><i class="fas fa-calendar-check"></i> Improve resource planning</div>
                    <div class="value-point"><i class="fas fa-shield-alt"></i> Enhance customer retention</div>
                </div>
            </div>
        </header>
        
        <!-- MAIN CONTENT -->
        <main>
            <!-- LEFT COLUMN: PREDICTION INPUTS -->
            <div class="left-column">
                <!-- SINGLE PREDICTION SECTION -->
                <section class="section">
                    <h2><i class="fas fa-user-check"></i> Single Booking Prediction</h2>
                    <p>Enter booking details to predict cancellation probability:</p>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="leadTime"><i class="far fa-calendar-alt"></i> Lead Time (days)</label>
                            <input type="number" id="leadTime" class="form-control" placeholder="e.g., 120" min="0" value="120">
                        </div>
                        
                        <div class="form-group">
                            <label for="adr"><i class="fas fa-money-bill-wave"></i> Average Daily Rate ($)</label>
                            <input type="number" id="adr" class="form-control" placeholder="e.g., 100" min="0" step="0.01" value="100">
                        </div>
                        
                        <div class="form-group">
                            <label for="specialRequests"><i class="fas fa-star"></i> Special Requests</label>
                            <input type="number" id="specialRequests" class="form-control" placeholder="0-5" min="0" max="5" value="1">
                        </div>
                        
                        <div class="form-group">
                            <label for="marketSegment"><i class="fas fa-globe"></i> Market Segment</label>
                            <select id="marketSegment" class="form-control">
                                <option value="0">Direct</option>
                                <option value="1" selected>Corporate</option>
                                <option value="2">Online TA</option>
                                <option value="3">Offline TA/TO</option>
                                <option value="4">Complementary</option>
                                <option value="5">Groups</option>
                                <option value="6">Aviation</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="depositType"><i class="fas fa-hand-holding-usd"></i> Deposit Type</label>
                            <select id="depositType" class="form-control">
                                <option value="0" selected>No Deposit</option>
                                <option value="1">Non Refund</option>
                                <option value="2">Refundable</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="previousCancellations"><i class="fas fa-ban"></i> Previous Cancellations</label>
                            <input type="number" id="previousCancellations" class="form-control" placeholder="0-10" min="0" max="10" value="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="bookingChanges"><i class="fas fa-edit"></i> Booking Changes</label>
                            <input type="number" id="bookingChanges" class="form-control" placeholder="0-10" min="0" max="10" value="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="parkingSpaces"><i class="fas fa-parking"></i> Required Parking Spaces</label>
                            <input type="number" id="parkingSpaces" class="form-control" placeholder="0-3" min="0" max="3" value="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="arrivalMonth"><i class="fas fa-calendar"></i> Arrival Month</label>
                            <select id="arrivalMonth" class="form-control">
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10" selected>October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                    </div>
                    
                    <button id="predictSingle" class="btn btn-block"><i class="fas fa-bolt"></i> Predict Cancellation Probability</button>
                </section>
                
                <!-- BATCH PREDICTION SECTION -->
                <section class="section">
                    <h2><i class="fas fa-users"></i> Batch Prediction</h2>
                    <p>Upload a CSV file with multiple bookings for batch processing:</p>
                    
                    <div class="file-upload-area" id="dropArea">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h3>Drag & Drop CSV File</h3>
                        <p>or click to browse</p>
                        <input type="file" id="csvFile" accept=".csv" style="display: none;">
                        <p class="file-info" id="fileInfo">No file selected</p>
                    </div>
                    
                    <div class="button-group">
                        <button id="predictBatch" class="btn btn-success"><i class="fas fa-cogs"></i> Process Batch</button>
                        <button id="downloadTemplate" class="btn"><i class="fas fa-download"></i> Download Template</button>
                        <button id="clearBatch" class="btn btn-danger"><i class="fas fa-trash"></i> Clear</button>
                    </div>
                </section>
            </div>
            
            <!-- RIGHT COLUMN: RESULTS & DASHBOARD -->
            <div class="right-column">
                <!-- SINGLE PREDICTION RESULTS -->
                <section class="section">
                    <h2><i class="fas fa-chart-pie"></i> Prediction Results</h2>
                    
                    <div class="loader" id="singleLoader">
                        <i class="fas fa-spinner"></i>
                        <p>Processing prediction...</p>
                    </div>
                    
                    <div id="singleResult" class="prediction-result risk-low" style="display: none;">
                        <h3><i class="fas fa-exclamation-triangle"></i> Cancellation Risk</h3>
                        <div class="probability-display" id="probabilityValue">25%</div>
                        <p><strong>Status:</strong> <span id="riskLevel">Low Risk</span></p>
                        
                        <div class="recommendation">
                            <h4><i class="fas fa-lightbulb"></i> Recommended Action</h4>
                            <p id="recommendationText">Standard confirmation process. No special action required.</p>
                        </div>
                    </div>
                    
                    <div id="noPredictionMessage" class="status-message status-info">
                        <i class="fas fa-info-circle"></i> Enter booking details and click "Predict" to see results
                    </div>
                </section>
                
                <!-- BUSINESS VALUE DASHBOARD -->
                <section class="section">
                    <h2><i class="fas fa-business-time"></i> Business Impact Dashboard</h2>
                    
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <i class="fas fa-money-bill-wave" style="color: #27ae60; font-size: 2rem;"></i>
                            <div class="metric-value" id="monthlySavings">$12,450</div>
                            <div class="metric-label">Estimated Monthly Savings</div>
                        </div>
                        
                        <div class="metric-card">
                            <i class="fas fa-chart-line" style="color: #3498db; font-size: 2rem;"></i>
                            <div class="metric-value" id="riskReduction">68%</div>
                            <div class="metric-label">Risk Reduction Rate</div>
                        </div>
                        
                        <div class="metric-card">
                            <i class="fas fa-shield-alt" style="color: #9b59b6; font-size: 2rem;"></i>
                            <div class="metric-value" id="revenueProtection">92%</div>
                            <div class="metric-label">Revenue Protection Score</div>
                        </div>
                        
                        <div class="metric-card">
                            <i class="fas fa-bed" style="color: #e74c3c; font-size: 2rem;"></i>
                            <div class="metric-value" id="highRiskBookings">14</div>
                            <div class="metric-label">High-Risk Bookings</div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="savingsChart"></canvas>
                    </div>
                </section>
                
                <!-- BATCH RESULTS -->
                <section class="section">
                    <h2><i class="fas fa-table"></i> Batch Results Summary</h2>
                    
                    <div class="loader" id="batchLoader" style="display: none;">
                        <i class="fas fa-spinner"></i>
                        <p>Processing batch file...</p>
                    </div>
                    
                    <div id="batchSummary" style="display: none;">
                        <p><strong>Total Processed:</strong> <span id="totalProcessed">0</span> bookings</p>
                        <p><strong>High Risk:</strong> <span id="highRiskCount">0</span> (<span id="highRiskPercent">0%</span>)</p>
                        <p><strong>Potential Revenue at Risk:</strong> $<span id="revenueAtRisk">0</span></p>
                        
                        <div class="batch-results">
                            <table id="batchResultsTable">
                                <thead>
                                    <tr>
                                        <th>Booking ID</th>
                                        <th>Cancellation Risk</th>
                                        <th>Probability</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="batchResultsBody">
                                    <!-- Results will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <button id="exportResults" class="btn btn-block" style="margin-top: 20px;">
                            <i class="fas fa-file-export"></i> Export Results to CSV
                        </button>
                    </div>
                    
                    <div id="noBatchMessage" class="status-message status-info">
                        <i class="fas fa-info-circle"></i> Upload a CSV file to see batch results
                    </div>
                </section>
            </div>
        </main>
        
        <!-- FOOTER -->
        <footer>
            <div class="footer-links">
                <a href="https://github.com/yourusername/hotel-booking-predictor" target="_blank">
                    <i class="fab fa-github"></i> GitHub Repository
                </a>
                <a href="https://www.kaggle.com/datasets/jessemostipak/hotel-booking-demand" target="_blank">
                    <i class="fab fa-kaggle"></i> Dataset Source
                </a>
                <a href="#" id="viewModelDetails">
                    <i class="fas fa-brain"></i> Model Details
                </a>
            </div>
            <p>© 2024 Hotel Booking Cancellation Predictor | Deployed with Flask</p>
            <p><small>MLP Neural Network Model | Accuracy: 87% | Precision: 0.85 | Recall: 0.82</small></p>
        </footer>
    </div>
    
    <!-- JAVASCRIPT -->
    <script>
        // Global variables
        let batchData = [];
        let savingsChart = null;
        
        // DOM Elements
        const predictSingleBtn = document.getElementById('predictSingle');
        const predictBatchBtn = document.getElementById('predictBatch');
        const csvFileInput = document.getElementById('csvFile');
        const dropArea = document.getElementById('dropArea');
        const singleResult = document.getElementById('singleResult');
        const probabilityValue = document.getElementById('probabilityValue');
        const riskLevel = document.getElementById('riskLevel');
        const recommendationText = document.getElementById('recommendationText');
        const batchSummary = document.getElementById('batchSummary');
        const batchResultsBody = document.getElementById('batchResultsBody');
        const singleLoader = document.getElementById('singleLoader');
        const batchLoader = document.getElementById('batchLoader');
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeUI();
            initializeCharts();
            
            // Event listeners
            predictSingleBtn.addEventListener('click', predictSingle);
            predictBatchBtn.addEventListener('click', predictBatch);
            csvFileInput.addEventListener('change', handleFileSelect);
            
            // Drag and drop for CSV
            dropArea.addEventListener('click', () => csvFileInput.click());
            dropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropArea.style.borderColor = '#3498db';
                dropArea.style.backgroundColor = 'rgba(52, 152, 219, 0.1)';
            });
            dropArea.addEventListener('dragleave', () => {
                dropArea.style.borderColor = '#7f8c8d';
                dropArea.style.backgroundColor = '';
            });
            dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dropArea.style.borderColor = '#7f8c8d';
                dropArea.style.backgroundColor = '';
                
                if (e.dataTransfer.files.length) {
                    csvFileInput.files = e.dataTransfer.files;
                    handleFileSelect();
                }
            });
            
            // Other button listeners
            document.getElementById('clearBatch').addEventListener('click', clearBatch);
            document.getElementById('downloadTemplate').addEventListener('click', downloadTemplate);
            document.getElementById('exportResults').addEventListener('click', exportResults);
            document.getElementById('viewModelDetails').addEventListener('click', showModelDetails);
        });
        
        // Initialize UI components
        function initializeUI() {
            // Set current date in footer
            const year = new Date().getFullYear();
            document.querySelector('footer p').innerHTML = `© ${year} Hotel Booking Cancellation Predictor | Deployed with Flask`;
            
            // Update file info display
            csvFileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    const file = this.files[0];
                    document.getElementById('fileInfo').textContent = `Selected: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
                    document.getElementById('noBatchMessage').style.display = 'none';
                }
            });
        }
        
        // Initialize charts
        function initializeCharts() {
            const ctx = document.getElementById('savingsChart').getContext('2d');
            savingsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Without Model', 'With Model'],
                    datasets: [{
                        label: 'Monthly Loss from Cancellations ($)',
                        data: [18500, 6050],
                        backgroundColor: [
                            'rgba(231, 76, 60, 0.7)',
                            'rgba(39, 174, 96, 0.7)'
                        ],
                        borderColor: [
                            'rgba(231, 76, 60, 1)',
                            'rgba(39, 174, 96, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `$${context.raw.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Predict single booking via Flask API
        async function predictSingle() {
            // Show loader
            singleLoader.style.display = 'block';
            singleResult.style.display = 'none';
            document.getElementById('noPredictionMessage').style.display = 'none';
            
            // Get form values
            const inputData = {
                lead_time: parseFloat(document.getElementById('leadTime').value) || 0,
                adr: parseFloat(document.getElementById('adr').value) || 0,
                special_requests: parseFloat(document.getElementById('specialRequests').value) || 0,
                market_segment: parseFloat(document.getElementById('marketSegment').value) || 0,
                deposit_type: parseFloat(document.getElementById('depositType').value) || 0,
                previous_cancellations: parseFloat(document.getElementById('previousCancellations').value) || 0,
                booking_changes: parseFloat(document.getElementById('bookingChanges').value) || 0,
                parking_spaces: parseFloat(document.getElementById('parkingSpaces').value) || 0,
                arrival_month: parseFloat(document.getElementById('arrivalMonth').value) || 1
            };
            
            try {
                // Send to Flask API
                const response = await fetch('/predict_single', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(inputData)
                });
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                const probabilityPercent = result.probability;
                
                // Determine risk level
                let riskClass, riskText, recommendation;
                
                if (probabilityPercent < 30) {
                    riskClass = 'risk-low';
                    riskText = 'Low Risk';
                    recommendation = 'Standard confirmation process. No special action required.';
                } else if (probabilityPercent < 70) {
                    riskClass = 'risk-medium';
                    riskText = 'Medium Risk';
                    recommendation = 'Consider sending a reminder email and offering flexible change options.';
                } else {
                    riskClass = 'risk-high';
                    riskText = 'High Risk';
                    recommendation = 'Recommend contacting the customer directly and offering a discount for non-refundable booking.';
                }
                
                // Update UI
                probabilityValue.textContent = `${probabilityPercent.toFixed(1)}%`;
                riskLevel.textContent = riskText;
                recommendationText.textContent = result.recommendation || recommendation;
                
                // Update result styling
                singleResult.className = `prediction-result ${riskClass}`;
                
                // Update business metrics
                updateBusinessMetrics(probabilityPercent, riskText);
                
                // Hide loader and show results
                singleLoader.style.display = 'none';
                singleResult.style.display = 'block';
                
            } catch (error) {
                console.error('Prediction error:', error);
                // Fallback to mock prediction
                const inputArray = Object.values(inputData);
                const probability = mockPrediction(inputArray);
                const probabilityPercent = Math.round(probability * 100);
                
                // Determine risk level
                let riskClass, riskText, recommendation;
                
                if (probabilityPercent < 30) {
                    riskClass = 'risk-low';
                    riskText = 'Low Risk';
                    recommendation = 'Standard confirmation process. No special action required.';
                } else if (probabilityPercent < 70) {
                    riskClass = 'risk-medium';
                    riskText = 'Medium Risk';
                    recommendation = 'Consider sending a reminder email and offering flexible change options.';
                } else {
                    riskClass = 'risk-high';
                    riskText = 'High Risk';
                    recommendation = 'Recommend contacting the customer directly and offering a discount for non-refundable booking.';
                }
                
                // Update UI
                probabilityValue.textContent = `${probabilityPercent}%`;
                riskLevel.textContent = riskText;
                recommendationText.textContent = recommendation;
                
                // Update result styling
                singleResult.className = `prediction-result ${riskClass}`;
                
                // Update business metrics
                updateBusinessMetrics(probabilityPercent, riskText);
                
                // Hide loader and show results
                singleLoader.style.display = 'none';
                singleResult.style.display = 'block';
                
                showStatus(`Using fallback prediction: ${error.message}`, 'warning');
            }
        }
        
        // Mock prediction function (if Flask API fails)
        function mockPrediction(inputData) {
            // Simple heuristic based on key factors
            let probability = 0.3; // Base probability
            
            // Adjust based on factors
            if (inputData[0] > 180) probability += 0.3; // Long lead time
            if (inputData[1] > 200) probability += 0.1; // High ADR
            if (inputData[2] > 3) probability -= 0.15; // Many special requests (less likely to cancel)
            if (inputData[4] === 0) probability += 0.2; // No deposit
            if (inputData[5] > 0) probability += 0.25; // Previous cancellations
            
            // Cap between 0 and 1
            return Math.max(0, Math.min(1, probability));
        }
        
        // Handle CSV file selection
        function handleFileSelect() {
            const file = csvFileInput.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    batchData = parseCSV(csvContent);
                    
                    // Update file info
                    document.getElementById('fileInfo').textContent = 
                        `Loaded: ${batchData.length} bookings from ${file.name}`;
                    
                    showStatus(`Successfully loaded ${batchData.length} bookings`, 'success');
                } catch (error) {
                    showStatus(`Error parsing CSV: ${error.message}`, 'error');
                }
            };
            reader.readAsText(file);
        }
        
        // Parse CSV content
        function parseCSV(csvContent) {
            const lines = csvContent.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                const values = lines[i].split(',').map(v => v.trim());
                const entry = {};
                
                headers.forEach((header, index) => {
                    entry[header] = values[index] || '';
                });
                
                data.push(entry);
            }
            
            return data;
        }
        
        // Predict batch of bookings via Flask API
        async function predictBatch() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showStatus('No file selected. Please upload a CSV file first.', 'error');
                return;
            }
            
            // Show loader
            batchLoader.style.display = 'block';
            batchSummary.style.display = 'none';
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                // Send to Flask API
                const response = await fetch('/predict_batch', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                // Update batch results UI
                updateBatchResultsFromAPI(result);
                
                // Hide loader and show results
                batchLoader.style.display = 'none';
                batchSummary.style.display = 'block';
                document.getElementById('noBatchMessage').style.display = 'none';
                
                // Update business metrics
                updateBusinessMetricsFromBatch(
                    result.total_processed, 
                    result.high_risk_count, 
                    result.revenue_at_risk
                );
                
            } catch (error) {
                console.error('Batch prediction error:', error);
                showStatus(`Error: ${error.message}. Using mock predictions.`, 'warning');
                
                // Fallback to local processing
                await localBatchPrediction();
            }
        }
        
        // Local batch prediction (fallback)
        async function localBatchPrediction() {
            if (batchData.length === 0) {
                showStatus('No data to process. Please upload a CSV file first.', 'error');
                return;
            }
            
            // Process each booking
            let highRiskCount = 0;
            let totalRevenueAtRisk = 0;
            const results = [];
            
            for (let i = 0; i < Math.min(batchData.length, 50); i++) {
                const booking = batchData[i];
                
                // Convert booking data to input array
                const inputArray = convertBookingToInput(booking);
                
                // Make mock prediction
                const probability = mockPrediction(inputArray);
                const probabilityPercent = Math.round(probability * 100);
                
                // Determine risk level
                let riskLevel, badgeClass;
                if (probabilityPercent < 30) {
                    riskLevel = 'Low';
                    badgeClass = 'badge-low';
                } else if (probabilityPercent < 70) {
                    riskLevel = 'Medium';
                    badgeClass = 'badge-medium';
                } else {
                    riskLevel = 'High';
                    badgeClass = 'badge-high';
                    highRiskCount++;
                    
                    // Estimate revenue at risk
                    const adr = parseFloat(booking.adr) || 100;
                    const leadTime = parseFloat(booking.lead_time) || 1;
                    totalRevenueAtRisk += adr * Math.min(leadTime, 7);
                }
                
                results.push({
                    id: booking.booking_id || i + 1,
                    probability: probabilityPercent,
                    riskLevel,
                    badgeClass
                });
            }
            
            // Update batch results UI
            updateBatchResults(results, highRiskCount, totalRevenueAtRisk);
            
            // Hide loader and show results
            batchLoader.style.display = 'none';
            batchSummary.style.display = 'block';
            
            // Update business metrics
            updateBusinessMetricsFromBatch(results.length, highRiskCount, totalRevenueAtRisk);
        }
        
        // Update batch results from Flask API response
        function updateBatchResultsFromAPI(result) {
            // Clear previous results
            batchResultsBody.innerHTML = '';
            
            // Add new results
            result.results.forEach((booking, index) => {
                const row = document.createElement('tr');
                const badgeClass = booking.risk_level === 'High' ? 'badge-high' : 
                                 booking.risk_level === 'Medium' ? 'badge-medium' : 'badge-low';
                
                row.innerHTML = `
                    <td>${booking.booking_id || index + 1}</td>
                    <td><span class="risk-badge ${badgeClass}">${booking.risk_level}</span></td>
                    <td>${booking.cancellation_probability ? booking.cancellation_probability.toFixed(1) + '%' : 'N/A'}</td>
                    <td>
                        <button class="btn" style="padding: 5px 10px; font-size: 0.8rem;" 
                                onclick="viewBookingDetails(${index})">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </td>
                `;
                batchResultsBody.appendChild(row);
            });
            
            // Update summary
            document.getElementById('totalProcessed').textContent = result.total_processed;
            document.getElementById('highRiskCount').textContent = result.high_risk_count;
            document.getElementById('highRiskPercent').textContent = 
                result.high_risk_percent ? result.high_risk_percent + '%' : '0%';
            document.getElementById('revenueAtRisk').textContent = 
                result.revenue_at_risk ? result.revenue_at_risk.toLocaleString() : '0';
        }
        
        // Update batch results (local fallback)
        function updateBatchResults(results, highRiskCount, totalRevenueAtRisk) {
            // Clear previous results
            batchResultsBody.innerHTML = '';
            
            // Add new results
            results.forEach(result => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${result.id}</td>
                    <td><span class="risk-badge ${result.badgeClass}">${result.riskLevel}</span></td>
                    <td>${result.probability}%</td>
                    <td>
                        <button class="btn" style="padding: 5px 10px; font-size: 0.8rem;" 
                                onclick="viewBookingDetails(${result.id})">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </td>
                `;
                batchResultsBody.appendChild(row);
            });
            
            // Update summary
            document.getElementById('totalProcessed').textContent = results.length;
            document.getElementById('highRiskCount').textContent = highRiskCount;
            document.getElementById('highRiskPercent').textContent = 
                results.length > 0 ? Math.round((highRiskCount / results.length) * 100) + '%' : '0%';
            document.getElementById('revenueAtRisk').textContent = 
                Math.round(totalRevenueAtRisk).toLocaleString();
        }
        
        // Convert booking object to input array
        function convertBookingToInput(booking) {
            return [
                parseFloat(booking.lead_time) || 0,
                parseFloat(booking.adr) || 0,
                parseFloat(booking.total_of_special_requests) || 0,
                parseFloat(booking.market_segment) || 0,
                parseFloat(booking.deposit_type) || 0,
                parseFloat(booking.previous_cancellations) || 0,
                parseFloat(booking.booking_changes) || 0,
                parseFloat(booking.required_car_parking_spaces) || 0,
                parseFloat(booking.arrival_date_month) || 1
            ];
        }
        
        // Update business metrics
        function updateBusinessMetrics(probabilityPercent, riskText) {
            const monthlySavings = document.getElementById('monthlySavings');
            const highRiskBookings = document.getElementById('highRiskBookings');
            
            // Simulate metric updates
            if (riskText === 'High Risk') {
                const currentCount = parseInt(highRiskBookings.textContent);
                highRiskBookings.textContent = currentCount + 1;
                
                const currentSavings = parseInt(monthlySavings.textContent.replace(/[$,]/g, ''));
                monthlySavings.textContent = '$' + (currentSavings + 250).toLocaleString();
            }
        }
        
        // Update business metrics from batch results
        function updateBusinessMetricsFromBatch(totalBookings, highRiskCount, totalRevenueAtRisk) {
            const monthlySavings = document.getElementById('monthlySavings');
            const highRiskBookings = document.getElementById('highRiskBookings');
            const riskReduction = document.getElementById('riskReduction');
            const revenueProtection = document.getElementById('revenueProtection');
            
            // Calculate updates
            const savingsPerHighRisk = 350;
            const newSavings = highRiskCount * savingsPerHighRisk;
            
            // Update metrics
            const currentSavings = parseInt(monthlySavings.textContent.replace(/[$,]/g, ''));
            monthlySavings.textContent = '$' + (currentSavings + newSavings).toLocaleString();
            
            const currentHighRisk = parseInt(highRiskBookings.textContent);
            highRiskBookings.textContent = currentHighRisk + highRiskCount;
            
            // Update risk reduction and protection scores
            if (totalBookings > 0) {
                const riskReductionValue = 100 - Math.min(100, (highRiskCount / totalBookings) * 100);
                riskReduction.textContent = Math.round(riskReductionValue) + '%';
                
                const protectionScore = 100 - Math.min(100, Math.round((totalRevenueAtRisk / (totalBookings * 150)) * 100));
                revenueProtection.textContent = protectionScore + '%';
            }
        }
        
        // Clear batch data
        function clearBatch() {
            csvFileInput.value = '';
            batchData = [];
            document.getElementById('fileInfo').textContent = 'No file selected';
            batchSummary.style.display = 'none';
            document.getElementById('noBatchMessage').style.display = 'block';
            showStatus('Batch data cleared', 'info');
        }
        
        // Download CSV template
        function downloadTemplate() {
            window.location.href = '/download_template';
        }
        
        // Export results to CSV
        function exportResults() {
            if (batchData.length === 0) {
                showStatus('No results to export', 'error');
                return;
            }
            
            // Create CSV content
            let csvContent = 'Booking ID,Risk Level,Probability,Lead Time,ADR,Special Requests\n';
            
            // Add data rows
            const rows = document.querySelectorAll('#batchResultsBody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 3) {
                    const id = cells[0].textContent;
                    const risk = cells[1].textContent;
                    const probability = cells[2].textContent;
                    
                    // Find corresponding data
                    const bookingIndex = parseInt(id) - 1;
                    const booking = batchData[bookingIndex] || {};
                    
                    csvContent += `${id},${risk},${probability},${booking.lead_time || 0},${booking.adr || 0},${booking.total_of_special_requests || 0}\n`;
                }
            });
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cancellation_predictions_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus('Results exported successfully', 'success');
        }
        
        // Show model details
        function showModelDetails() {
            alert(`Model Details:
• Architecture: MLP Neural Network (64-32-16 layers)
• Features: 9 input features (lead time, ADR, special requests, etc.)
• Framework: Scikit-learn MLPClassifier
• Training Data: Hotel Booking Demand Dataset
• Purpose: Predict booking cancellations to optimize revenue management`);
        }
        
        // View booking details
        function viewBookingDetails(index) {
            const booking = batchData[index] || {};
            
            const details = `
                <strong>Booking Details:</strong><br>
                • Lead Time: ${booking.lead_time || 'N/A'} days<br>
                • ADR: $${booking.adr || 'N/A'}<br>
                • Special Requests: ${booking.total_of_special_requests || 'N/A'}<br>
                • Market Segment: ${booking.market_segment || 'N/A'}<br>
                • Deposit Type: ${booking.deposit_type || 'N/A'}<br>
                • Previous Cancellations: ${booking.previous_cancellations || 'N/A'}<br>
                • Booking Changes: ${booking.booking_changes || 'N/A'}
            `;
            
            alert(details);
        }
        
        // Show status message
        function showStatus(message, type = 'info') {
            const statusEl = document.createElement('div');
            statusEl.className = `status-message status-${type}`;
            statusEl.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
            
            const container = document.querySelector('.container');
            container.insertBefore(statusEl, container.firstChild);
            
            setTimeout(() => {
                if (statusEl.parentNode) {
                    statusEl.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
